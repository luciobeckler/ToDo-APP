<div class="toolbar">
    <button (click)="showModal = true">+ Nova tarefa</button>
</div>

<div class="board">
    <ng-container *ngFor="let type of taskTypes">
        <div class="column" *ngIf="getTasksByType(type).length > 0">
            <!-- Caso não houver nenhuma tarefa no bloco, 
            ele não será renderizado -->
            <div class="header">{{ type }}</div>
            <table class="task-table">
                <thead>
                    <tr>
                        <th>Título</th>
                        <th>Grupo</th>
                        <th>Início</th>
                        <th>Fim</th>
                        <th>Prioridade</th>
                    </tr>
                </thead>
                <tbody>
                    <tr *ngFor="let task of getTasksByType(type)">
                        <!-- Título -->
                        <td (click)="editingField = { task, field: 'title' }">
                            <ng-container
                                *ngIf="editingField?.task !== task || editingField?.field !== 'title'; else titleEdit">
                                {{ task.title }}
                            </ng-container>
                            <ng-template #titleEdit>
                                <input
                                    [(ngModel)]="task.title"
                                    (blur)="editingField = null"
                                    autofocus />
                            </ng-template>
                        </td>

                        <!-- Grupo -->
                        <td (click)="editingField = { task, field: 'group' }">
                            <ng-container
                                *ngIf="editingField?.task !== task || editingField?.field !== 'group'; else groupEdit">
                                {{ task.group }}
                            </ng-container>
                            <ng-template #groupEdit>
                                <select
                                    [(ngModel)]="task.group"
                                    (blur)="editingField = null"
                                    (change)="editingField = null"
                                    autofocus>
                                    <option value="Trabalho">Trabalho</option>
                                    <option value="Pessoal">Pessoal</option>
                                    <option value="Outro">Outro</option>
                                </select>
                            </ng-template>
                        </td>

                        <!-- Início -->
                        <td
                            (click)="editingField = { task, field: 'startDateTime' }">
                            <ng-container
                                *ngIf="editingField?.task !== task || editingField?.field !== 'startDateTime'; else startEdit">
                                {{ task.startDateTime ? (task.startDateTime |
                                date:'dd/MM/yyyy') : '-' }}
                            </ng-container>
                            <ng-template #startEdit>
                                <input
                                    type="date"
                                    [(ngModel)]="task.startDateTime"
                                    (blur)="editingField = null"
                                    autofocus />
                            </ng-template>
                        </td>

                        <!-- Fim -->
                        <td
                            (click)="editingField = { task, field: 'endDateTime' }">
                            <ng-container
                                *ngIf="editingField?.task !== task || editingField?.field !== 'endDateTime'; else endEdit">
                                {{ task.endDateTime ? (task.endDateTime |
                                date:'dd/MM/yyyy') : '-' }}
                            </ng-container>
                            <ng-template #endEdit>
                                <input
                                    type="date"
                                    [(ngModel)]="task.endDateTime"
                                    (blur)="editingField = null"
                                    autofocus />
                            </ng-template>
                        </td>

                        <!-- Prioridade -->
                        <td
                            (click)="editingField = { task, field: 'priority' }">
                            <ng-container
                                *ngIf="editingField?.task !== task || editingField?.field !== 'priority'; else priorityEdit">
                                {{ task.priority }}
                            </ng-container>
                            <ng-template #priorityEdit>
                                <select
                                    [(ngModel)]="task.priority"
                                    (blur)="editingField = null"
                                    (change)="editingField = null"
                                    autofocus>
                                    <option value="Alta">Alta</option>
                                    <option value="Normal">Normal</option>
                                    <option value="Baixa">Baixa</option>
                                </select>
                            </ng-template>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </ng-container>
</div>

<div class="modal-backdrop" *ngIf="showModal">
    <div class="modal">
        <h2>Criar nova tarefa</h2>
        <form (ngSubmit)="addTask()" #taskForm="ngForm">
            <label>Título: <input [(ngModel)]="newTask.title" name="title"
                    required /></label>
            <label>Grupo: <input [(ngModel)]="newTask.group" name="group"
                    required /></label>
            <label>Início: <input type="date"
                    [(ngModel)]="newTask.startDateTime"
                    name="startDateTime" /></label>
            <label>Fim: <input type="date" [(ngModel)]="newTask.endDateTime"
                    name="endDateTime" /></label>
            <label>Prioridade:
                <select [(ngModel)]="newTask.priority" name="priority" required>
                    <option value="Alta">Alta</option>
                    <option value="Normal">Normal</option>
                    <option value="Baixa">Baixa</option>
                </select>
            </label>
            <label>Status:
                <select [(ngModel)]="newTask.type" name="type" required>
                    <option *ngFor="let type of taskTypes" [value]="type">{{
                        type }}</option>
                </select>
            </label>

            <div class="modal-actions">
                <button type="submit"
                    [disabled]="!taskForm.form.valid">Salvar</button>
                <button type="button"
                    (click)="showModal = false">Cancelar</button>
            </div>
        </form>
    </div>
</div>
